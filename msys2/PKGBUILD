_realname=openFPGALoader
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=ci
pkgrel=1
pkgdesc="openFPGALoader: universal utility for programming FPGA (mingw-w64)"
arch=('any')
url="https://github.com/trabucayre/openFPGALoader"
license=('AGPLv3.0')
depends=("${MINGW_PACKAGE_PREFIX}-libftdi")
makedepends=("${MINGW_PACKAGE_PREFIX}-gcc"
             "${MINGW_PACKAGE_PREFIX}-cmake")

source=()
sha256sums=()

build() {
  cd "${srcdir}"/../..
  mkdir build
  cd build
  cmake \
    -G "MinGW Makefiles" \
    -DCMAKE_INSTALL_PREFIX="${pkgdir}${MINGW_PREFIX}" \
    ../
  cmake --build .
}

check() {
  "${srcdir}"/../../build/openFPGALoader.exe --help
}

package() {
  # FIXME: `make install` opens an interactive prompt locally and does nothing in CI
  #cd "${srcdir}/${_realname}"/build
  #mkdir -p "${pkgdir}${MINGW_PREFIX}"
  #make install

  cd "${srcdir}"/../..

  _bin="${pkgdir}${MINGW_PREFIX}"/bin
  _licenses="${pkgdir}${MINGW_PREFIX}/share/licenses/${_realname}"
  _data="${pkgdir}${MINGW_PREFIX}/share/data/${_realname}"
  mkdir -p "${_bin}" "${_licenses}" "${_data}"

  install -m 744 build/openFPGALoader.exe "${_bin}"
  install -m 644 LICENSE "${_licenses}"
  install -m 644 test_sfl.svf "${_data}"
  install -m 644 spiOverJtag/*.bit "${_data}"
}
